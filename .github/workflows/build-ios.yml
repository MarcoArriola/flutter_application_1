name: Build iOS App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-ios-simulator:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run analyze
      run: flutter analyze
    
    - name: Build iOS app for Simulator (Debug)
      run: flutter build ios --simulator --debug
    
    - name: Create zip for Simulator
      run: |
        cd build/ios/iphonesimulator
        zip -r -q ../../../ios-simulator.zip Runner.app
    
    - name: Upload iOS Simulator build
      uses: actions/upload-artifact@v4
      with:
        name: ios-simulator
        path: ios-simulator.zip
        retention-days: 30

  build-ios-device:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build iOS app for Device (Ad-hoc)
      run: |
        flutter build ios --release --no-codesign
      continue-on-error: true
    
    - name: Create IPA without code signing
      run: |
        mkdir -p Payload
        cp -r build/ios/iphoneos/Runner.app Payload/
        zip -r -q ios-unsigned.ipa Payload
        rm -rf Payload
      continue-on-error: true
    
    - name: Upload unsigned IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-unsigned
        path: ios-unsigned.ipa
        retention-days: 30
      continue-on-error: true
